import smtplib
from email.message import EmailMessage
from prompt_toolkit import PromptSession
from prompt_toolkit.key_binding import KeyBindings

def run():
    email = EmailMessage()

    session = PromptSession()

    kb = KeyBindings()

    @kb.add('c-j')
    def _(event):
        event.app.current_buffer.insert_text('\n')

    @kb.add('enter')
    def _(event):
        event.app.exit(result=event.app.current_buffer.text)

    while True:
        try:
            author = input("Provide the author(from header obfuscator): ")
            subject = input("Provide the subject: ")
            print("Provide the content of the email(Press Ctrl + j to change line and Enter to end the text): ")
            content = session.prompt(">> ", multiline=True, key_bindings=kb)
            your_email = input("Provide your email: ")
            app_password = input("Provide the app password")
            receiver = input("Provide the target's email: ")
            break
        except (EOFError, KeyboardInterrupt):
            print("\nInput cancelled.")
            break

    email["From"] = f"{author} <{your_email}>"
    email["To"] = receiver
    email["Subject"] = subject
    email.set_content(content)
    email.add_alternative(content, subtype="html")

    smtp_server = "smtp.gmail.com"
    smtp_port = 465

    with smtplib.SMTP_SSL(smtp_server,smtp_port) as smtp:
        smtp.login(f"{your_email}",f"{app_password}")
        smtp.send_message(email)
    
    print("Phishing attack sent.")


        
        
                    



